# ===========================================
# KERBERUS Production Docker Compose
# Uses Docker Secrets for sensitive data
# ===========================================

services:
  kerberus:
    image: kerberus:latest
    container_name: kerberus-app
    ports:
      - "8000:8000"
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - POSTGRES_HOST=postgres
      - REDIS_HOST=redis
      # Secrets are mounted as files at /run/secrets/
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
      - LLM_API_KEY_FILE=/run/secrets/llm_api_key
      - CHAINLIT_AUTH_SECRET_FILE=/run/secrets/chainlit_auth_secret
    secrets:
      - postgres_password
      - llm_api_key
      - chainlit_auth_secret
    volumes:
      - dossier_data:/app/data/dossier
    depends_on:
      - qdrant
      - postgres
      - redis
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped
    networks:
      - kerberus-network

  qdrant:
    image: qdrant/qdrant:latest
    container_name: kerberus-qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_storage:/qdrant/storage
    deploy:
      resources:
        limits:
          memory: 4G
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - kerberus-network

  redis:
    image: redis:7-alpine
    container_name: kerberus-redis
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          memory: 512M
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - kerberus-network

  postgres:
    image: postgres:15-alpine
    container_name: kerberus-postgres
    environment:
      - POSTGRES_DB=kerberus
      - POSTGRES_USER=kerberus_user
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
    secrets:
      - postgres_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          memory: 1G
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kerberus_user"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - kerberus-network

# ===========================================
# Docker Secrets (create before deployment)
# ===========================================
# Create secrets with:
#   echo "your_password" | docker secret create postgres_password -
#   echo "your_api_key" | docker secret create llm_api_key -
#   echo "your_secret" | docker secret create chainlit_auth_secret -
# ===========================================
secrets:
  postgres_password:
    external: true
  llm_api_key:
    external: true
  chainlit_auth_secret:
    external: true

networks:
  kerberus-network:
    driver: overlay

volumes:
  qdrant_storage:
  redis_data:
  postgres_data:
  dossier_data:
